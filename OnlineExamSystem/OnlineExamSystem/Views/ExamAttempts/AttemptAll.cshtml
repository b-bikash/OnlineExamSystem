@model OnlineExamSystem.Models.ExamAttempt

@{
    ViewData["Title"] = "Attempt Exam";
    var questionIndex = 1;
}

<style>
    .question-sidebar {
        position: sticky;
        top: 90px;
    }

    .question-number {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 1px solid #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        margin-bottom: 10px;
        font-weight: 500;
        background-color: #fff;
    }

        .question-number.answered {
            background-color: #198754;
            color: #fff;
            border-color: #198754;
        }

        .question-number.unanswered {
            background-color: #e9ecef;
            color: #000;
        }

    .question-card {
        scroll-margin-top: 90px;
    }
</style>

<div class="container-fluid my-4">
    <div class="row">

        <!-- LEFT SIDEBAR -->
        <div class="col-md-2 d-none d-md-block">
            <div class="question-sidebar">
                @for (int i = 1; i <= Model.Exam.Questions.Count; i++)
                {
                    <div class="question-number unanswered"
                         data-question="@i">
                        @i
                    </div>
                }
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="col-md-10">

            <!-- Exam Header -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h2 class="mb-2">@Model.Exam.Title</h2>

                    @if (!string.IsNullOrWhiteSpace(Model.Exam.Description))
                    {
                        <p class="text-muted mb-0">
                            @Model.Exam.Description
                        </p>
                    }
                </div>
            </div>

            <form method="post"
                  action="/ExamAttempts/SubmitAll"
                  id="examForm">

                @Html.AntiForgeryToken()
                <input type="hidden" name="attemptId" value="@Model.Id" />

                @{
                    questionIndex = 1;
                }

                @foreach (var question in Model.Exam.Questions)
                {
                    <div class="card mb-4 shadow-sm question-card"
                         id="question-@questionIndex"
                         data-question-index="@questionIndex">
                        <div class="card-body">

                            <div class="mb-3 fw-semibold">
                                Question @questionIndex
                            </div>

                            <div class="mb-3">
                                @question.Text
                            </div>

                            @foreach (var option in question.Options)
                            {
                                <div class="form-check mb-2">
                                    <input class="form-check-input"
                                           type="radio"
                                           name="answers[@question.Id]"
                                           value="@option.Id"
                                           data-question="@questionIndex"
                                           id="q@questionIndex_opt@option.Id"
                                           @(Model.StudentAnswers.Any(a =>
                                                                              a.QuestionId == question.Id &&
                                                                              a.SelectedOptionId == option.Id)
                                                                              ? "checked" : "") />

                                    <label class="form-check-label"
                                           for="q@questionIndex_opt@option.Id">
                                        @option.Text
                                    </label>
                                </div>
                            }
                        </div>
                    </div>

                    questionIndex++;
                }

                <div class="text-end">
                    <button type="submit"
                            class="btn btn-danger px-4">
                        Submit Exam
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- SUBMIT CONFIRM MODAL -->
<div class="modal fade"
     id="confirmSubmitModal"
     tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Submit Exam?</h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                You have not answered all the questions.<br />
                Are you sure you want to submit?
            </div>

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button"
                        class="btn btn-danger"
                        id="confirmSubmitBtn">
                    Submit Anyway
                </button>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        const form = document.getElementById("examForm");
        const modal = new bootstrap.Modal(
            document.getElementById("confirmSubmitModal")
        );

        // Scroll on sidebar click
        document.querySelectorAll(".question-number").forEach(q => {
            q.addEventListener("click", () => {
                const index = q.getAttribute("data-question");
                document.getElementById("question-" + index)
                    .scrollIntoView({ behavior: "smooth" });
            });
        });

        // Update answered state
        document.querySelectorAll("input[type='radio']").forEach(radio => {
            radio.addEventListener("change", () => {
                const index = radio.getAttribute("data-question");
                const badge = document.querySelector(
                    `.question-number[data-question='${index}']`
                );
                badge.classList.remove("unanswered");
                badge.classList.add("answered");
            });
        });

        // Submit validation
        form.addEventListener("submit", function (e) {
            const total = @Model.Exam.Questions.Count;
            const answered =
                document.querySelectorAll("input[type='radio']:checked").length;

            if (answered < total) {
                e.preventDefault();
                modal.show();
            }
        });

        document.getElementById("confirmSubmitBtn")
            .addEventListener("click", function () {
                modal.hide();
                form.submit();
            });
    </script>
}
