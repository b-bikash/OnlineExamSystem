@using Microsoft.AspNetCore.Http
@using OnlineExamSystem.Models
@using OnlineExamSystem.Models.ViewModels
@model object

@{
    ViewData["Title"] = "Exams";
    var role = Context.Session.GetString("Role");
    var now = DateTime.Now;
}

<h2>Exams</h2>

@* ================= STUDENT VIEW ================= *@
@if (role == "Student")
{
    var studentModel = Model as StudentExamsViewModel;

    if (!studentModel.IsProfileCompleted)
    {
        <div class="alert alert-warning">
            <strong>Complete your profile to access exams.</strong><br />
            <a asp-controller="Students" asp-action="Profile" class="alert-link">
                Complete Profile
            </a>
        </div>
    }
    else
    {
        <div class="accordion" id="studentExamAccordion">

            <!-- LIVE EXAMS -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#studentLiveExams">
                        Live Exams
                    </button>
                </h2>

                <div id="studentLiveExams" class="accordion-collapse collapse show">
                    <div class="accordion-body">

                        @if (!studentModel.LiveExams.Any())
                        {
                            <p>No live exams available.</p>
                        }
                        else
                        {
                            <table class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Subject</th>
                                        <th>Ends At</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var exam in studentModel.LiveExams)
                                    {
                                        <tr>
                                            <td>@exam.Title</td>
                                            <td>@exam.Subject?.Name</td>
                                            <td>@exam.EndDateTime</td>
                                            <td>
                                                <a asp-controller="ExamAttempts"
                                                   asp-action="Start"
                                                   asp-route-examId="@exam.Id"
                                                   class="btn btn-sm btn-success">
                                                    Start Exam
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                    </div>
                </div>
            </div>

            <!-- UPCOMING EXAMS -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#studentUpcomingExams">
                        Upcoming Exams
                    </button>
                </h2>

                <div id="studentUpcomingExams" class="accordion-collapse collapse">
                    <div class="accordion-body">

                        @if (!studentModel.UpcomingExams.Any())
                        {
                            <p>No upcoming exams.</p>
                        }
                        else
                        {
                            <table class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Subject</th>
                                        <th>Starts At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var exam in studentModel.UpcomingExams)
                                    {
                                        <tr>
                                            <td>@exam.Title</td>
                                            <td>@exam.Subject?.Name</td>
                                            <td>@exam.StartDateTime</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                    </div>
                </div>
            </div>

            <!-- ATTEMPTED EXAMS -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#studentAttemptedExams">
                        Attempted Exams
                    </button>
                </h2>

                <div id="studentAttemptedExams" class="accordion-collapse collapse">
                    <div class="accordion-body">

                        @if (!studentModel.AttemptedExams.Any())
                        {
                            <p>No attempted exams yet.</p>
                        }
                        else
                        {
                            <table class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Subject</th>
                                        <th>Teacher</th>
                                        <th>Your Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in studentModel.AttemptedExams)
                                    {
                                        <tr>
                                            <td>@item.Exam.Title</td>
                                            <td>@item.Exam.Subject?.Name</td>
                                            <td>@item.TeacherName</td>
                                            <td>@item.Attempt.Score</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                    </div>
                </div>
            </div>

        </div>
    }
}

@* ================= TEACHER VIEW ================= *@
@if (role == "Teacher")
{
    var exams = (Model as IEnumerable<Exam>) ?? Enumerable.Empty<Exam>();

    var unscheduled = exams
        .Where(e => !e.StartDateTime.HasValue)
        .OrderByDescending(e => e.CreatedAt)
        .ToList();

    var scheduled = exams
        .Where(e => e.StartDateTime.HasValue)
        .OrderByDescending(e => e.StartDateTime)
        .ToList();

    <a asp-action="Create" class="btn btn-primary mb-3">Create Exam</a>

    <h4>Unscheduled Exams</h4>
    @if (!unscheduled.Any())
    {
        <p>No unscheduled exams.</p>
    }
    else
    {
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Subject</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var exam in unscheduled)
                {
                    <tr>
                        <td>@exam.Title</td>
                        <td>@exam.Subject?.Name</td>
                        <td>
                            <a asp-action="Edit" asp-route-id="@exam.Id" class="btn btn-sm btn-warning">Edit</a>
                            <a asp-action="Assign" asp-route-id="@exam.Id" class="btn btn-sm btn-secondary">Schedule</a>
                            <a asp-controller="Questions" asp-action="Index"
                               asp-route-examId="@exam.Id"
                               class="btn btn-sm btn-info">Questions</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <h4 class="mt-4">Scheduled Exams</h4>
    @if (!scheduled.Any())
    {
        <p>No scheduled exams.</p>
    }
    else
    {
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Subject</th>
                    <th>Schedule</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var exam in scheduled)
                {
                    <tr>
                        <td>@exam.Title</td>
                        <td>@exam.Subject?.Name</td>
                        <td>@exam.StartDateTime → @exam.EndDateTime</td>
                        <td>
                            <a asp-action="Results" asp-route-examId="@exam.Id"
                               class="btn btn-sm btn-dark">Results</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@* ================= ADMIN VIEW ================= *@
@if (role == "Admin")
{
    var exams = Model as IEnumerable<AdminExamListItemViewModel>;

    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Title</th>
                <th>Teacher</th>
                <th>Description</th>
                <th>Duration</th>
                <th>Total Marks</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var exam in exams)
            {
                <tr>
                    <td>@exam.Title</td>
                    <td>@exam.TeacherName</td>
                    <td>@exam.Description</td>
                    <td>@exam.DurationInMinutes</td>
                    <td>@exam.TotalMarks</td>
                </tr>
            }
        </tbody>
    </table>
}
