@using Microsoft.AspNetCore.Http
@using OnlineExamSystem.Models
@using OnlineExamSystem.Models.ViewModels
@model object

@{
    var role = Context.Session.GetString("Role");
    var now = DateTime.Now;
}
@*
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">
        @TempData["SuccessMessage"]
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-warning">
        @TempData["ErrorMessage"]
    </div>
}
*@

<h2>Exams</h2>

@* ================= STUDENT VIEW ================= *@
@if (role == "Student")
{
    var studentModel = Model as StudentExamsViewModel;
    
    @if (!studentModel.IsProfileCompleted)
    {
        <div class="alert alert-warning">
            <strong>Complete your profile to access exams.</strong><br />
            Please complete your profile first. You will be able to view and attempt exams only after your profile is completed.
            <br />
            <a asp-controller="Students" asp-action="Profile" class="alert-link">
                Complete Profile
            </a>
        </div>
    }

    <div class="accordion" id="studentExamAccordion">

        <!-- LIVE EXAMS -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#studentLiveExams">
                    Live Exams
                </button>
            </h2>

            <div id="studentLiveExams"
                 class="accordion-collapse collapse show">
                <div class="accordion-body">

                    @if (!studentModel.LiveExams.Any())
                    {
                        <p>No live exams available.</p>
                    }
                    else
                    {
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Duration (mins)</th>
                                    <th>Ends At</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var exam in studentModel.LiveExams)
                                {
                                    <tr>
                                        <td>@exam.Title</td>
                                        <td>@exam.DurationInMinutes</td>
                                        <td>@exam.EndDateTime</td>
                                        <td>
                                            <a asp-controller="ExamAttempts"
                                               asp-action="Start"
                                               asp-route-examId="@exam.Id"
                                               class="btn btn-sm btn-success">
                                                Start Exam
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }

                </div>
            </div>
        </div>

        <!-- UPCOMING EXAMS -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#studentUpcomingExams">
                    Upcoming Exams
                </button>
            </h2>

            <div id="studentUpcomingExams"
                 class="accordion-collapse collapse">
                <div class="accordion-body">

                    @if (!studentModel.UpcomingExams.Any())
                    {
                        <p>No upcoming exams.</p>
                    }
                    else
                    {
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Starts At</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var exam in studentModel.UpcomingExams)
                                {
                                    <tr>
                                        <td>@exam.Title</td>
                                        <td>@exam.StartDateTime</td>
                                        <td>
                                            <span class="badge bg-secondary">Upcoming</span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }

                </div>
            </div>
        </div>

        <!-- ATTEMPTED EXAMS -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#studentAttemptedExams">
                    Attempted Exams
                </button>
            </h2>

            <div id="studentAttemptedExams"
                 class="accordion-collapse collapse">
                <div class="accordion-body">

                    @if (!studentModel.AttemptedExams.Any())
                    {
                        <p>No attempted exams yet.</p>
                    }
                    else
                    {
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Total Marks</th>
                                    <th>Teacher</th>
                                    <th>Your Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in studentModel.AttemptedExams)
                                {
                                    <tr>
                                        <td>@item.Exam.Title</td>
                                        <td>@item.Exam.TotalMarks</td>
                                        <td>@item.TeacherName</td>
                                        <td>
                                            @if (item.Exam.EndDateTime.HasValue &&
                                                                            item.Exam.EndDateTime.Value < DateTime.Now &&
                                                                            item.Attempt.EndTime.HasValue)
                                            {
                                                <span class="fw-bold">@item.Attempt.Score</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Results not declared yet</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }

                </div>
            </div>
        </div>

    </div>
}


@* ================= TEACHER VIEW ================= *@
@if (role == "Teacher")
{
    var exams = (Model as IEnumerable<Exam>) ?? Enumerable.Empty<Exam>();

    var unassigned = exams
        .Where(e => !e.CollegeId.HasValue || !e.CourseId.HasValue)
        .OrderByDescending(e => e.CreatedAt)
        .ToList();

    var upcomingOrLive = exams
        .Where(e => e.CollegeId.HasValue && e.CourseId.HasValue &&
                    e.EndDateTime.HasValue && e.EndDateTime.Value >= now)
        .OrderByDescending(e => e.StartDateTime ?? e.CreatedAt)
        .ToList();

    var past = exams
        .Where(e => e.EndDateTime.HasValue && e.EndDateTime.Value < now)
        .OrderByDescending(e => e.EndDateTime)
        .ToList();

    <a asp-action="Create" class="btn btn-primary mb-3">Create Exam</a>

    <div class="accordion" id="teacherExamAccordion">

        <!-- UNASSIGNED -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#unassignedExams">
                    Unassigned Exams
                </button>
            </h2>

            <div id="unassignedExams"
                 class="accordion-collapse collapse show">
                <div class="accordion-body">

                    @if (!unassigned.Any())
                    {
                        <p>No unassigned exams.</p>
                    }
                    else
                    {
                        var sn = 1;
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>S.No</th>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Duration</th>
                                    <th>Total Marks</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var exam in unassigned)
                                {
                                    <tr>
                                        <td>@sn</td>
                                        <td>@exam.Title</td>
                                        <td>@exam.Description</td>
                                        <td>@exam.DurationInMinutes</td>
                                        <td>@exam.TotalMarks</td>
                                        <td>
                                            <a asp-action="Edit" asp-route-id="@exam.Id"
                                               class="btn btn-sm btn-warning">Edit</a>
                                            <a asp-action="Delete" asp-route-id="@exam.Id"
                                               class="btn btn-sm btn-danger">Delete</a>
                                            <a asp-controller="Questions" asp-action="Index"
                                               asp-route-examId="@exam.Id"
                                               class="btn btn-sm btn-info">Questions</a>
                                            <a asp-action="Assign" asp-route-id="@exam.Id"
                                               class="btn btn-sm btn-secondary">Assign</a>
                                        </td>
                                    </tr>
                                    sn++;
                                }
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>

        <!-- UPCOMING / LIVE -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#upcomingLiveExams">
                    Upcoming / Live Exams
                </button>
            </h2>

            <div id="upcomingLiveExams"
                 class="accordion-collapse collapse show">
                <div class="accordion-body">

                    @if (!upcomingOrLive.Any())
                    {
                        <p>No upcoming or live exams.</p>
                    }
                    else
                    {
                        var sn = 1;
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>S.No</th>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Duration</th>
                                    <th>Total Marks</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var exam in upcomingOrLive)
                                {
                                    <tr>
                                        <td>@sn</td>
                                        <td>@exam.Title</td>
                                        <td>@exam.Description</td>
                                        <td>@exam.DurationInMinutes</td>
                                        <td>@exam.TotalMarks</td>
                                        <td>
                                            <a asp-action="Edit" asp-route-id="@exam.Id"
                                               class="btn btn-sm btn-warning">Edit</a>
                                            <a asp-action="Delete" asp-route-id="@exam.Id"
                                               class="btn btn-sm btn-danger">Delete</a>
                                            <a asp-controller="Questions" asp-action="Index"
                                               asp-route-examId="@exam.Id"
                                               class="btn btn-sm btn-info">Questions</a>
                                            <a asp-action="Assign" asp-route-id="@exam.Id"
                                               class="btn btn-sm btn-secondary">Assign</a>
                                        </td>
                                    </tr>
                                    sn++;
                                }
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>

        <!-- PAST -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#pastExams">
                    Past Exams
                </button>
            </h2>

            <div id="pastExams"
                 class="accordion-collapse collapse">
                <div class="accordion-body">

                    @if (!past.Any())
                    {
                        <p>No past exams.</p>
                    }
                    else
                    {
                        var sn = 1;
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>S.No</th>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Duration</th>
                                    <th>Total Marks</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var exam in past)
                                {
                                    <tr>
                                        <td>@sn</td>
                                        <td>@exam.Title</td>
                                        <td>@exam.Description</td>
                                        <td>@exam.DurationInMinutes</td>
                                        <td>@exam.TotalMarks</td>
                                        <td>
                                            <a asp-controller="Questions" asp-action="Index"
                                               asp-route-examId="@exam.Id"
                                               class="btn btn-sm btn-info">Questions</a>
                                            <a asp-action="Results" asp-route-examId="@exam.Id"
                                               class="btn btn-sm btn-dark">Results</a>
                                        </td>
                                    </tr>
                                    sn++;
                                }
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>

    </div>
}


@* ================= ADMIN VIEW ================= *@
@if (role == "Admin")
{
    var exams = Model as IEnumerable<AdminExamListItemViewModel>;

    <a asp-action="Create" class="btn btn-primary mb-3">Create Exam</a>

    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Title</th>
                <th>Teacher</th>
                <th>Description</th>
                <th>Duration</th>
                <th>Total Marks</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var exam in exams)
            {
                <tr>
                    <td>@exam.Title</td>
                    <td>@exam.TeacherName</td>
                    <td>@exam.Description</td>
                    <td>@exam.DurationInMinutes</td>
                    <td>@exam.TotalMarks</td>
                    <td>
                        <a asp-action="Edit" asp-route-id="@exam.ExamId" class="btn btn-sm btn-warning">Edit</a>
                        <a asp-action="Delete" asp-route-id="@exam.ExamId" class="btn btn-sm btn-danger">Delete</a>
                        <a asp-controller="Questions" asp-action="Index" asp-route-examId="@exam.ExamId"
                           class="btn btn-sm btn-info">Questions</a>
                        <a asp-action="Assign" asp-route-id="@exam.ExamId" class="btn btn-sm btn-secondary">Assign</a>
                        <a asp-action="Results" asp-route-examId="@exam.ExamId" class="btn btn-sm btn-dark">Results</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
